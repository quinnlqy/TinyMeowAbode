# 天气系统配置指南

## 📋 配置文件位置
`scripts/data/WeatherConfig.js`

## 🌦️ 天气配置说明

### 1. 月度天气概率配置
在 `monthly_probability` 中配置每个月的下雨和下雪概率：

```javascript
monthly_probability: {
    1: { rain: 0, snow: 0.2 },   // 1月：下雪20%，下雨0%
    2: { rain: 0, snow: 0.1 },   // 2月：下雪10%，下雨0%
    // ... 其他月份
}
```

**配置规则：**
- `rain`：下雨概率（0.0 - 1.0，例如 0.3 = 30%）
- `snow`：下雪概率（0.0 - 1.0，例如 0.5 = 50%）
- 下雪优先级高于下雨
- 剩余概率自动为晴天

**示例：**
- `{ rain: 0.3, snow: 0.2 }` = 20%下雪 + 30%下雨 + 50%晴天
- `{ rain: 0, snow: 0.5 }` = 50%下雪 + 50%晴天

### 2. 特殊日期天气配置 ⭐ NEW
在 `special_date_weather` 中配置特定日期的固定天气：

```javascript
special_date_weather: {
    "12-25": "snow",  // 圣诞节必定下雪
    "1-1": "snow",    // 元旦必定下雪
    "2-14": "clear",  // 情人节晴天
    "10-31": "rain",  // 万圣节下雨
}
```

**配置规则：**
- 格式：`"月-日": "天气类型"`
- 天气类型：`"clear"`（晴天）、`"rain"`（雨天）、`"snow"`（雪天）
- 特殊日期配置优先级最高，会覆盖月度概率配置
- 这些天气会被记录到日记中

### 3. 当前配置（冬季下雪方案）
```
10月：下雪10%
11月：下雪20%
12月：下雪50%
1月：下雪20%
2月：下雪10%
其他月份：晴天

特殊日期：
12月25日：必定下雪 ❄️
1月1日：必定下雪 ❄️
```

### 4. 天气文案配置
在 `weather_descriptions` 中配置不同天气类型对应的日记描述：

```javascript
weather_descriptions: {
    clear: ["☀️ 阳光正好，适合烤毛", ...],  // 晴天文案
    rain: ["🌧️ 下雨了，睡个回笼觉", ...],    // 雨天文案
    snow: ["❄️ 下雪了，窗外一片白", ...]     // 雪天文案
}
```

## 🔄 天气同步机制

### 工作流程
1. 每天首次启动游戏时，`WeatherSystem` 根据以下优先级生成天气：
   - **优先级1：** 检查是否有特殊日期配置（如12月25日必定下雪）
   - **优先级2：** 根据当前月份的概率随机生成天气
2. 生成的天气会自动同步到游戏场景（显示雨雪效果）
3. `DiaryManager` 从 `WeatherSystem` 获取天气描述，写入日记
4. **玩家手动切换的天气（通过天气按钮或GM命令）不会被记录到日记**

### 天气来源区分 ⭐ NEW
- **自然天气**：每日自动生成的天气（基于月度概率或特殊日期）→ 会记录到日记
- **手动天气**：玩家通过天气按钮或GM命令切换的天气 → 不会记录到日记

### 同步时机
- 游戏启动时（`startGame()` 函数）
- 每帧检查日期变化（午夜跨天时自动触发）
- 生成日记元数据时（`generateDailyMeta()` 函数）

## 🎯 如何修改天气概率

### 示例1：春季增加下雨
```javascript
3: { rain: 0.3, snow: 0 },   // 3月：30%下雨
4: { rain: 0.4, snow: 0 },   // 4月：40%下雨
5: { rain: 0.3, snow: 0 },   // 5月：30%下雨
```

### 示例2：夏季增加雷雨
```javascript
6: { rain: 0.5, snow: 0 },   // 6月：50%下雨
7: { rain: 0.6, snow: 0 },   // 7月：60%下雨
8: { rain: 0.5, snow: 0 },   // 8月：50%下雨
```

### 示例3：秋季增加阴天（暂时用晴天，未来可扩展）
```javascript
9: { rain: 0.2, snow: 0 },   // 9月：20%下雨，80%晴天
```

### 示例4：添加更多特殊日期 ⭐ NEW
```javascript
special_date_weather: {
    "12-25": "snow",   // 圣诞节下雪
    "1-1": "snow",     // 元旦下雪
    "2-14": "clear",   // 情人节晴天
    "5-20": "clear",   // 520晴天
    "10-31": "rain",   // 万圣节下雨
    "11-11": "clear",  // 双十一晴天
}
```

## 🔧 技术说明

### 核心文件
1. `WeatherConfig.js` - 天气配置表
2. `WeatherSystem.js` - 天气系统（负责场景天气效果）
3. `DiaryManager.js` - 日记管理器（负责记录天气到日记）

### 关键函数
- `WeatherSystem.checkDailyWeather()` - 每日天气检查
- `WeatherSystem.getWeatherDescription()` - 获取天气描述文案
- `DiaryManager.generateDailyMeta()` - 生成日记元数据（包含天气）

## 📝 注意事项
1. 修改配置后需要刷新页面（Ctrl+F5）
2. 天气在每天首次启动时随机生成，同一天内不会改变（除非跨越午夜）
3. 特殊日期的天气配置优先级最高，会覆盖月度概率配置
4. **手动切换天气（天气按钮/GM命令）不会影响日记记录** ⭐ NEW
   - 玩家点击天气按钮或使用GM命令切换的天气仅用于视觉效果
   - 日记中记录的天气始终是每日自动生成的自然天气
5. 特殊节日的心情/事件配置在 `DiaryConfig.js` 中，与天气配置分开管理
