<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="color-scheme" content="light">
    <!-- Google Fonts 已移除，以优化国内访问速度 -->
    <title>Tiny Meow Abode - 方寸喵居</title>
    <!-- 外部CSS样式表 -->
    <link rel="stylesheet" href="./styles/main.css">
    <link rel="stylesheet" href="./styles/photo-mode.css">
    <!-- [新增] 移动端响应式样式 -->
    <link rel="stylesheet" href="./styles/mobile.css">
    <!-- 内联样式已迁移到 styles/main.css -->
    <script>
        function logToScreen(msg, type = 'info') {
            const consoleDiv = document.getElementById('debug-console');
            if (consoleDiv) {
                const line = document.createElement('div');
                line.textContent = `> ${msg}`;
                if (type === 'error') line.className = 'log-error';
                else if (type === 'warn') line.className = 'log-warn'; consoleDiv.appendChild(line); consoleDiv.scrollTop = consoleDiv.scrollHeight;
            } console.log(msg);
        }

        // === [诊断系统] 把崩溃日志写入 localStorage，下次加载时可查看 ===
        (function setupCrashDiagnostics() {
            var crashLogKey = 'cat_game_crash_log';
            var maxLogs = 30;

            // 写入崩溃日志
            window._logCrash = function (msg) {
                try {
                    var logs = JSON.parse(localStorage.getItem(crashLogKey) || '[]');
                    logs.push({ t: new Date().toISOString(), m: msg });
                    if (logs.length > maxLogs) logs = logs.slice(-maxLogs);
                    localStorage.setItem(crashLogKey, JSON.stringify(logs));
                } catch (e) { }
            };

            // 全局 JS 错误
            window.onerror = function (msg, url, line, col, err) {
                var detail = 'ERROR: ' + msg + ' (Line ' + line + ':' + col + ')';
                if (err && err.stack) detail += '\nStack: ' + err.stack.substring(0, 300);
                logToScreen(detail, 'error');
                window._logCrash(detail);
                return false;
            };

            // 未捕获的 Promise 错误
            window.addEventListener('unhandledrejection', function (event) {
                var msg = 'PROMISE ERROR: ' + (event.reason ? (event.reason.message || event.reason) : 'unknown');
                if (event.reason && event.reason.stack) msg += '\nStack: ' + event.reason.stack.substring(0, 300);
                logToScreen(msg, 'error');
                window._logCrash(msg);
            });

            // 读取上次崩溃日志（如果有的话）
            window._getCrashLogs = function () {
                try { return JSON.parse(localStorage.getItem(crashLogKey) || '[]'); } catch (e) { return []; }
            };
            window._clearCrashLogs = function () {
                localStorage.removeItem(crashLogKey);
            };

            // 如果上次有崩溃记录，在控制台输出
            var prevLogs = window._getCrashLogs();
            if (prevLogs.length > 0) {
                console.warn('[诊断] 上次运行的崩溃日志 (' + prevLogs.length + ' 条):');
                prevLogs.forEach(function (l) { console.warn('  ' + l.t + ': ' + l.m); });
            }
        })();
    </script>
    <!-- vConsole 已移除，如需调试请手动加载 -->
</head>

<body>

    <!-- [诊断] 崩溃日志浮层，点击版本号5次触发 -->
    <div id="crash-log-overlay"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:99999; overflow-y:auto; padding:15px; box-sizing:border-box;">
        <div style="color:#0f0; font-family:monospace; font-size:12px; white-space:pre-wrap; word-break:break-all;"
            id="crash-log-content"></div>
        <button onclick="document.getElementById('crash-log-overlay').style.display='none'"
            style="position:fixed; top:10px; right:10px; background:#f44; color:#fff; border:none; padding:8px 16px; border-radius:5px; font-size:14px; z-index:100000;">关闭</button>
        <button
            onclick="window._clearCrashLogs && window._clearCrashLogs(); document.getElementById('crash-log-content').textContent='已清空'"
            style="position:fixed; top:10px; right:70px; background:#666; color:#fff; border:none; padding:8px 16px; border-radius:5px; font-size:14px; z-index:100000;">清空</button>
        <button id="btn-reset-game" onclick="window._confirmResetGame()"
            style="position:fixed; bottom:15px; left:50%; transform:translateX(-50%); background:#ff2222; color:#fff; border:2px solid #fff; padding:10px 24px; border-radius:8px; font-size:15px; font-weight:bold; z-index:100000;">⚠️
            重置所有数据</button>
    </div>
    <script>
        // 连续点击版本号5次显示崩溃日志
        (function () {
            var tapCount = 0, tapTimer = null;
            window._showCrashOverlay = function () {
                var overlay = document.getElementById('crash-log-overlay');
                var content = document.getElementById('crash-log-content');
                if (!overlay || !content) return;
                var logs = window._getCrashLogs ? window._getCrashLogs() : [];
                var statusInfo = '\n\n--- 当前状态 ---\n'
                    + '- load_attempts: ' + (localStorage.getItem('cat_game_load_attempts') || '0')
                    + '\n- safeMode: ' + (window._safeMode || false)
                    + '\n- 阴影灯光: ' + (window._furnitureShadowCount || 0) + '/' + (window._maxShadowLights || '?')
                    + '\n- 阴影投射: ' + (window._shadowCasterCount || 0) + '/' + (window._maxShadowCasters || '?')
                    + '\n- 家具数量: ' + (window._placedFurnitureCount || '?')
                    + '\n- 未恢复家具: ' + (window._unrestoredCount || '?');
                if (logs.length === 0) {
                    content.textContent = '没有崩溃日志。' + statusInfo;
                } else {
                    content.textContent = '崩溃日志 (' + logs.length + ' 条):\n\n' + logs.map(function (l) { return l.t + '\n  ' + l.m; }).join('\n\n') + statusInfo;
                }
                overlay.style.display = 'block';
            };
            document.addEventListener('click', function (e) {
                var el = e.target;
                if (el && (el.id === 'version-text' || el.id === 'game-version')) {
                    tapCount++;
                    clearTimeout(tapTimer);
                    tapTimer = setTimeout(function () { tapCount = 0; }, 2000);
                    if (tapCount >= 5) {
                        tapCount = 0;
                        window._showCrashOverlay();
                    }
                }
            });

            // 重置游戏（二次确认）
            window._confirmResetGame = function () {
                if (!confirm('⚠️ 确定要清除所有游戏数据吗？\n\n这将删除存档、日记、设置等所有数据，无法恢复！')) return;
                if (!confirm('⚠️ 再次确认：真的要重置吗？\n\n所有数据将被永久删除！')) return;
                try {
                    localStorage.clear();
                    sessionStorage.clear();
                    alert('所有数据已清除，页面即将刷新。');
                    window.location.reload();
                } catch (e) {
                    alert('清除失败: ' + e.message);
                }
            };
        })();
    </script>

    <!-- 放置提示 (PC端放置家具时显示) -->
    <!-- 全局提示框 (跟随鼠标) -->
    <div id="global-tooltip" style="display:none;"></div>

    <div id="loading-screen">
        <div id="loading-text">资源加载中...</div>
        <div id="progress-bar">
            <div id="progress-fill"></div>
        </div>
        <div id="version-text"
            style="position:absolute; bottom:10px; right:10px; color:rgba(255,255,255,0.5); font-size:12px;"></div>
        <!-- force-start-btn 已移除 -->
    </div>

    <div id="confirm-dialog">
        <h3 id="dialog-title">补充猫粮?</h3>
        <p id="dialog-msg">需要消耗 10 爱心</p>
        <div class="dialog-btns">
            <button class="dialog-btn btn-no" onclick="closeDialog()">取消</button>
            <button class="dialog-btn btn-yes" id="btn-confirm-yes">确定</button>
        </div>
    </div>



    <div id="tutorial">
        <strong>方寸喵居 (Tiny Meow Abode)</strong><br>
        1. 修复猫咪睡觉"踢腿"/来回走<br>
        2. 吃饭对准/站猫砂盆上<br>
        3. 状态栏常驻左下角<br>
        <div style="margin-top:5px; border-top:1px solid #ccc; padding-top:5px;"><span id="status-text">初始化...</span>
        </div>
    </div>

    <!-- ================== 新版 HUD ================== -->

    <!-- 1. 左上角：时间与状态 -->
    <div id="hud-top-left">
        <!-- 时间组件 -->
        <div id="time-widget">
            <div id="time-bg">
                <!-- 显示时间 -->
                <span id="time-text-display">12:00</span>
                <span id="time-ampm">PM</span>
            </div>
            <!-- 天气/光影控制入口 -->
            <div id="weather-icon-container" onclick="toggleTimePopover()">
                <img id="weather-icon-img" src="./assets/ui/icon_sun.png">
            </div>
            <!-- [新增] 天气切换按钮 -->
            <div id="weather-toggle-btn" onclick="cycleWeather()">
                <img src="./assets/ui/weather/weather_bg.png" class="weather-btn-bg">
                <img id="weather-btn-icon" src="./assets/ui/weather/sunny.png" class="weather-btn-icon">
            </div>
            <!-- 隐藏的滑块控制条 (Popover) -->
            <div id="time-popover" class="hidden">
                <input type="range" id="time-slider-hud" min="0" max="23.99" step="0.01">
                <button id="time-reset-btn" title="重置时间">↻</button>
            </div>
        </div>

        <!-- 爱心组件 -->
        <div id="heart-widget">
            <!-- 图标放在背景外面，方便绝对定位 -->
            <img src="./assets/ui/icon_heart.png" id="heart-icon-img">
            <div id="heart-bg">
                <span id="heart-text-display">500</span>
            </div>
        </div>

        <!-- 生理状态组件 -->
        <div id="status-widget-group">
            <!-- 饱食度 -->
            <div class="status-circle">
                <!-- 1. 底层 Frame -->
                <img src="./assets/ui/hunger_icon_frame.png" class="status-frame">

                <!-- 2. 中间 Mask (负责切圆角) -->
                <div class="liquid-mask">
                    <!-- [新增] 水位容器 (负责控制高度) -->
                    <div class="liquid-level" id="level-hunger">
                        <!-- 液体纹理 (高度固定，沉底) -->
                        <img src="./assets/ui/hunger_icon_fill.png" class="liquid-texture">
                    </div>
                </div>

                <!-- 3. 顶层 Icon -->
                <img src="./assets/ui/hunger_icon.png" class="status-icon-fg">
            </div>

            <!-- 便便值 -->
            <div class="status-circle">
                <img src="./assets/ui/toilet_icon_frame.png" class="status-frame">
                <div class="liquid-mask">
                    <div class="liquid-level" id="level-toilet">
                        <img src="./assets/ui/toilet_icon_fill.png" class="liquid-texture">
                    </div>
                </div>
                <img src="./assets/ui/toilet_icon.png" class="status-icon-fg">
            </div>
        </div>

    </div>

    <!-- [新增] 右上角 Debug 工具栏 HTML -->
    <div id="debug-panel">
        <button class="debug-btn debug-only" style="display:none;" onclick="debugAddMoney()">+$$</button>
        <button class="debug-btn debug-only" style="display:none;" onclick="debugResetCat()">重置猫</button>
        <button class="debug-btn debug-only" style="display:none;" onclick="window.debugCatInfo()">🐱 猫咪状态</button>
        <button class="debug-btn debug-only" style="display:none;" onclick="window.debugForceToilet()">🚽 上厕所</button>
        <button class="debug-btn debug-only" style="display:none;" onclick="toggleDebugGizmos()">线框</button>
        <button class="debug-btn debug-only" style="display:none;" onclick="toggleConsole()">📜 日志</button>
        <button class="debug-btn debug-only" style="display:none;" onclick="window.debugGenDiary()">📝 生成</button>
        <button class="debug-btn debug-only" style="display:none;" onclick="window.debugClearDiary()">🗑️ 清空</button>
        <!-- [新增] 阴影开关按钮 -->
        <button class="debug-btn debug-only" style="display:none;" onclick="window.toggleShadows()">🌑 阴影</button>
        <button class="debug-btn debug-only" style="display:none;" onclick="window.toggleWeather()">🌤️ 天气</button>
        <!-- [新增] 存档导出/导入按钮 -->
        <button class="debug-btn" onclick="window.exportSaveToFile()">💾 保存</button>
        <button class="debug-btn" onclick="window.importSaveFromFile()">📂 读取</button>
        <button class="debug-btn" onclick="window.showManual()">📖 游戏说明</button>
        <button class="debug-btn debug-only" style="display:none;" onclick="window.debugClearSave()"
            style="color:#ff6b6b;">🗑️ 清档</button>
    </div>

    <!-- 2. 底部：功能入口 -->
    <div id="hud-bottom-bar">
        <div class="hud-btn-container" onclick="toggleDiary()">
            <img src="./assets/ui/btn_diary.png" class="hud-main-btn">
            <div id="diary-red-dot-hud"></div>
        </div>
        <div class="hud-btn-container" onclick="toggleShop()">
            <img src="./assets/ui/btn_shop.png" class="hud-main-btn">
        </div>
    </div>

    <!-- [新增] 画质设置面板 -->
    <div id="graphics-settings-panel" class="hidden">
        <div class="gfx-panel-title">画质设置</div>
        <div class="gfx-row">
            <span class="gfx-label">阴影</span>
            <button id="gfx-toggle-shadow" class="gfx-toggle" onclick="toggleGraphicsSetting('shadow')">开</button>
        </div>
        <div class="gfx-row">
            <span class="gfx-label">辉光 (Bloom)</span>
            <button id="gfx-toggle-bloom" class="gfx-toggle" onclick="toggleGraphicsSetting('bloom')">开</button>
        </div>
        <div class="gfx-row">
            <span class="gfx-label">环境光遮蔽 (SSAO)</span>
            <button id="gfx-toggle-ssao" class="gfx-toggle" onclick="toggleGraphicsSetting('ssao')">开</button>
        </div>
        <div class="gfx-row">
            <span class="gfx-label">移轴模糊</span>
            <button id="gfx-toggle-tiltShift" class="gfx-toggle" onclick="toggleGraphicsSetting('tiltShift')">开</button>
        </div>
        <div class="gfx-row">
            <span class="gfx-label">抗锯齿 (SMAA)</span>
            <button id="gfx-toggle-smaa" class="gfx-toggle" onclick="toggleGraphicsSetting('smaa')">开</button>
        </div>
        <div class="gfx-hint">开启更多效果画面更好，但可能影响性能</div>
    </div>

    <!-- [新增] 移动端专属操作栏（编辑模式时显示） -->
    <div id="mobile-controls">
        <button id="btn-mobile-cancel" class="mobile-ctrl-btn">❌</button>
        <button id="btn-mobile-rotate" class="mobile-ctrl-btn">🔄</button>
        <button id="btn-mobile-confirm" class="mobile-ctrl-btn">✅</button>
    </div>

    <!-- 3. 商店面板 (修改原有结构，增加关闭按钮) -->
    <!-- 3. 商店面板 (软木板风格) -->
    <div id="shop-panel-container" class="hidden-bottom">

        <!-- 背景板上的标题牌 -->
        <img src="./assets/ui/shop_title_sign.png" id="shop-title-img">

        <!-- 关闭按钮 -->
        <button id="shop-close-btn" onclick="toggleShop()"></button>

        <!-- 页签栏 (图标化) -->
        <div id="shop-tabs">
            <!-- 家具 -->
            <div class="shop-tab active" onclick="switchCategory('furniture')">
                <img src="./assets/ui/tab_bg_active.png" class="tab-bg">
                <img src="./assets/ui/tab_furniture.png" class="tab-icon">
            </div>
            <!-- 小物件 -->
            <div class="shop-tab" onclick="switchCategory('small')">
                <img src="./assets/ui/tab_bg_active.png" class="tab-bg">
                <img src="./assets/ui/tab_small.png" class="tab-icon">
            </div>
            <!-- 壁挂物 -->
            <div class="shop-tab" onclick="switchCategory('wall')">
                <img src="./assets/ui/tab_bg_active.png" class="tab-bg">
                <img src="./assets/ui/tab_wall.png" class="tab-icon">
            </div>
            <!-- 墙纸 -->
            <div class="shop-tab" onclick="switchCategory('wallpaper')">
                <img src="./assets/ui/tab_bg_active.png" class="tab-bg">
                <img src="./assets/ui/tab_wallpaper.png" class="tab-icon">
            </div>
            <!-- 地板 -->
            <div class="shop-tab" onclick="switchCategory('flooring')">
                <img src="./assets/ui/tab_bg_active.png" class="tab-bg">
                <img src="./assets/ui/tab_flooring.png" class="tab-icon">
            </div>
            <!-- 地毯 -->
            <div class="shop-tab" onclick="switchCategory('rug')">
                <img src="./assets/ui/tab_bg_active.png" class="tab-bg">
                <img src="./assets/ui/tab_rug.png" class="tab-icon">
            </div>
        </div>

        <!-- 商品列表滚动区 -->
        <div id="items-scroll">
            <!-- JS 动态填充 -->
        </div>

        <!-- 2. 自定义滚动条组件 -->
        <div id="custom-scrollbar">
            <div id="custom-track"></div> <!-- 绳子 -->
            <div id="custom-thumb"></div> <!-- 猫头 -->
        </div>
    </div>




    <div id="context-menu">
        <div class="context-btn" id="btn-move">移动位置</div>
        <div class="context-btn btn-delete" id="btn-delete">删除家具</div>
        <div class="context-btn" id="btn-cancel">取消选中</div>
    </div>
    <div id="cat-bubble" class="bubble hidden"><span id="bubble-icon">🐟</span></div>

    <!-- 常驻状态面板 -->
    <div id="debug-panel">
        <button class="debug-btn" id="btn-save" onclick="window.exportSaveToFile()">💾 保存</button>
        <button class="debug-btn" id="btn-load" onclick="window.importSaveFromFile()">📂 读取</button>
        <button class="debug-btn" id="btn-manual" onclick="window.showManual()">📖 说明</button>
        <button class="debug-btn" id="btn-graphics" onclick="toggleGraphicsPanel()">⚙ 画质</button>
        <span id="game-version"
            style="color: rgba(255,255,255,0.7); font-size: 10px; margin-left: 5px; align-self: center;">V1.3</span>
    </div>


    <!-- 日记本弹窗 (模态框) -->
    <div id="diary-modal" class="hidden">
        <div id="diary-book-container">
            <!-- 关闭按钮 -->
            <button id="diary-close-btn" onclick="toggleDiary()"></button>

            <!-- 日记书本背景 -->
            <img src="./assets/ui/diary_book_bg.png" id="diary-bg-img">

            <!-- 左页内容 -->
            <div id="diary-left-page">
                <!-- 拍立得照片框 -->
                <div id="polaroid-frame">
                    <img src="./assets/ui/diary_photo_placeholder_Frame.png" class="polaroid-bg">
                    <img src="./assets/ui/diary_photo_placeholder_Chrismas.png" class="polaroid-photo">
                    <img src="./assets/ui/diary_tape.png" class="polaroid-tape">
                    <span id="diary-photo-date" class="polaroid-text">Oct 24</span>
                    <span id="diary-photo-weather" class="polaroid-text">天气晴朗，适合睡觉</span>

                    <!-- [新增] 手动拍照按钮 -->
                    <button id="manual-photo-btn" onclick="window.takeManualPhoto()" title="拍一张今天的照片">
                        <img src="./assets/ui/icon_camera_fixed.png" alt="拍照">
                    </button>
                </div>
                <!-- 装饰贴纸 -->
                <img src="./assets/ui/diary_deco_fish.png" class="diary-deco-fish-left">
            </div>

            <!-- 右页内容 -->
            <div id="diary-right-page">
                <!-- 日期标题 (从原来的h2移过来) -->
                <h3 id="diary-date-title" class="page-date-title">Oct 24</h3>
                <!-- 心情/关键词 (从原来的div移过来) -->
                <div id="diary-meta" class="page-meta">
                    <span id="diary-weather">🌤️ 天气不错</span> |
                    <span id="diary-mood">😾 心情一般</span>
                </div>

                <!-- 日记条目容器 -->
                <div id="diary-entries-scroll">
                    <!-- JS 会在这里填充日记条目 -->
                    <div class="entry empty-tip">今天还没有日记...</div>
                </div>
                <!-- 装饰贴纸 -->
                <img src="./assets/ui/diary_deco_fish.png" class="diary-deco-fish-right">
                <img src="./assets/ui/diary_deco_paw.png" class="diary-deco-paw">
            </div>

            <!-- 底部导航按钮 -->
            <div id="diary-nav-buttons">
                <button id="btn-diary-prev" onclick="diaryManager.changePage(-1)">
                    <img src="./assets/ui/btn_diary_prev.png">
                </button>
                <button id="btn-diary-next" onclick="diaryManager.changePage(1)">
                    <img src="./assets/ui/btn_diary_next.png">
                </button>
            </div>

        </div>
    </div>

    <!-- [新增] 拍照模式覆盖层 -->
    <div id="photo-mode-overlay" style="display: none;">
        <!-- 相机框架 -->
        <div id="camera-frame-container">
            <img src="./assets/ui/Camera.png" id="camera-frame-img">
            <!-- 取景框位置标记（用于截图定位） -->
            <div id="viewfinder-area"></div>
            <!-- 快门按钮 -->
            <button id="shutter-btn" onclick="window.capturePhoto()">
                <img src="./assets/ui/camera_button.png" id="camera-button-img">
            </button>
        </div>

        <!-- 退出按钮 -->
        <button id="exit-photo-mode-btn" onclick="window.exitPhotoMode()">✕</button>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://esm.sh/three@0.160.0", "three/addons/": "https://esm.sh/three@0.160.0/examples/jsm/" } }
    </script>

    <!-- 主要JS已迁移到 scripts/main.js -->
    <script type="module" src="./scripts/main.js"></script>
    <!-- <script type="module" src="./scripts/main.new.js"></script> -->
</body>

</html>